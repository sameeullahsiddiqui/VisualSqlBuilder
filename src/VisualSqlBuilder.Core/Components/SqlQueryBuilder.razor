@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop

@inject IJSRuntime JSRuntime
@inject ISchemaService SchemaService
@inject ISqlGeneratorService SqlGenerator
@inject IAzureOpenAIService OpenAIService
@implements IAsyncDisposable

<div class="visual-sql-builder">
    <div class="toolbar">
        <div class="btn-group" role="group">
            <button class="btn btn-primary" type="button" @onclick="ShowConnectionDialog">
                <i class="bi bi-database"></i> Connect Database
            </button>
            <InputFile id="excelFileInput" style="display:none" OnChange="HandleExcelSelected" />

            <button class="btn btn-success" type="button" @onclick="ShowExcelUpload">
                <i class="bi bi-file-earmark-excel"></i> Upload Excel
            </button>
            <button class="btn btn-info" type="button" @onclick="AddNewTable">
                <i class="bi bi-table"></i> Add Table
            </button>
            <button class="btn btn-info" type="button" @onclick="ShowCreateDomainModal">
                <i class="bi bi-diagram-3"></i> Add Domain
            </button>

            <button class="btn btn-warning" type="button" @onclick="SaveLayout">
                <i class="bi bi-save"></i> Save Layout
            </button>
            <button class="btn btn-secondary" type="button" @onclick="LoadLayout">
                <i class="bi bi-folder-open"></i> Load Layout
            </button>
            <button class="btn btn-outline-info" type="button" @onclick="AutoArrangeTables">
                <i class="bi bi-grid-3x3-gap"></i> Rearrange Layout
            </button>
        </div>

        <div class="btn-group ms-3" role="group">
            <button class="btn btn-outline-primary" type="button" @onclick="ZoomIn">
                <i class="bi bi-zoom-in"></i>
            </button>
            <button class="btn btn-outline-primary" type="button" @onclick="ZoomOut">
                <i class="bi bi-zoom-out"></i>
            </button>
            <button class="btn btn-outline-primary" type="button" @onclick="ResetZoom">
                <i class="bi bi-arrows-fullscreen"></i>
            </button>
        </div>

        <div class="btn-group ms-3" role="group">
            <button class="btn btn-success" type="button" @onclick="GenerateQuery">
                <i class="bi bi-code-square"></i> Generate Query
            </button>
            <button class="btn btn-success" type="button" @onclick="GenerateAndExecuteQuery">
                <i class="bi bi-play-fill"></i> Execute Query
            </button>
        </div>
    </div>

    <!-- Context Menus -->
    <ul id="rename-table-menu" class="context-menu">
        <li data-action="rename">Rename Table</li>
    </ul>

    <ul id="relationship-context-menu" class="context-menu">
        <li data-action="edit-join"><i class="bi bi-arrow-left-right"></i> Edit Join Type</li>
        <li data-action="delete-relationship"><i class="bi bi-trash"></i> Delete Relationship</li>
    </ul>

    <ul id="column-context-menu" class="context-menu">
        <li data-action="set-alias"><i class="bi bi-tag"></i> Set Column Alias</li>
        <li data-action="toggle-select"><i class="bi bi-check-square"></i> Toggle Selection</li>
    </ul>

    <div class="main-container">
        <div class="canvas-container" @ref="canvasElement" id="sql-canvas">

            <!-- SVG for relationship lines -->
            <svg class="relationship-layer">

                @foreach (var relationship in _queryModel.Relationships)
                {
                    var sourceTable = _queryModel.Tables.FirstOrDefault(t => t.Id == relationship.SourceTableId);
                    var targetTable = _queryModel.Tables.FirstOrDefault(t => t.Id == relationship.TargetTableId);

                    if (sourceTable != null && targetTable != null)
                    {
                        var sourceCol = sourceTable.Columns.FirstOrDefault(c => c.Id == relationship.SourceColumnId);
                        var targetCol = targetTable.Columns.FirstOrDefault(c => c.Id == relationship.TargetColumnId);

                        if (sourceCol != null && targetCol != null)
                        {
                            var sourceConnectorPos = GetConnectorPosition(sourceTable, sourceCol, "right");
                            var targetConnectorPos = GetConnectorPosition(targetTable, targetCol, "left");

                            var color = GetJoinTypeColor(relationship.JoinType);
                            var strokeWidth = relationship.JoinType == JoinType.InnerJoin ? "3" : "2";
                            var dashArray = GetJoinTypeDashArray(relationship.JoinType);

                            <line class="relationship-line @(relationship.JoinType.ToString().ToLower())"
                                  x1="@sourceConnectorPos.X"
                                  y1="@sourceConnectorPos.Y"
                                  x2="@targetConnectorPos.X"
                                  y2="@targetConnectorPos.Y"
                                  stroke="@color"
                                  stroke-width="@strokeWidth"
                                  stroke-dasharray="@dashArray"
                                  @onclick="@(() => EditRelationship(relationship))"
                                  data-relationship-id="@relationship.Id"
                                  data-source-table-id="@relationship.SourceTableId"
                                  data-target-table-id="@relationship.TargetTableId"
                                  data-source-column-id="@relationship.SourceColumnId"
                                  data-target-column-id="@relationship.TargetColumnId"
                                  style="cursor: pointer;" />

                            <!-- Join type label -->
                            <svg:text x="@((sourceConnectorPos.X + targetConnectorPos.X) / 2)"
                                      y="@((sourceConnectorPos.Y + targetConnectorPos.Y) / 2 - 10)"
                                      class="join-type-label"
                                      text-anchor="middle"
                                      style="font-size: 12px; fill: @color; font-weight: bold;">
                                @GetJoinTypeDisplayName(relationship.JoinType)
                            </svg:text>

                            <!-- Cardinality label -->
                            <svg:text x="@((sourceConnectorPos.X + targetConnectorPos.X) / 2)"
                                      y="@((sourceConnectorPos.Y + targetConnectorPos.Y) / 2 + 5)"
                                      class="cardinality-label"
                                      text-anchor="middle"
                                      style="font-size: 10px; fill: #666;">
                                @relationship.Cardinality
                            </svg:text>
                        }
                    }
                }
            </svg>

            <!-- Domains -->
            @foreach (var domain in _queryModel.Domains)
            {
                <div class="domain-container @(domain.IsCollapsed ? "collapsed" : "")" style="left: @(domain.Position.X)px; top: @(domain.Position.Y)px;
                                                                width: @(domain.Size.Width)px; height: @(domain.Size.Height)px;
                                                                background-color: @domain.Color;">
                    <div class="domain-header">
                        <span class="domain-name">@domain.Name</span>
                        <button class="btn btn-sm btn-link" @onclick="() => ToggleDomain(domain)">
                            <i class="bi bi-@(domain.IsCollapsed ? "chevron-down" : "chevron-up")"></i>
                        </button>
                    </div>
                </div>
            }

            <!-- Tables -->
            @foreach (var table in _queryModel.Tables)
            {
                <div class="table-card"
                     data-table-id="@table.Id"
                     style="left: @(table.Position.X)px; top: @(table.Position.Y)px;
                                                width: @(table.Size.Width)px; height: @(table.Size.Height)px;"
                     @onclick="() => SelectTable(table)">

                    <div class="table-card-header">
                        <span class="table-card-header-text">@table.Name</span>
                        @if (!string.IsNullOrEmpty(table.Alias) && table.Alias != table.Name)
                        {
                            <span class="table-alias">(@table.Alias)</span>
                        }
                        <button class="btn btn-sm btn-link text-white" type="button" @onclick="() => RemoveTable(table)">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    <div class="table-body">
                        @foreach (var column in table.Columns)
                        {
                            <div class="column-row">
                                <span class="column-connector left"
                                      data-column-id="@column.Id"
                                      data-table-id="@table.Id"
                                      title="Drag to create relationship">
                                </span>
                                <input type="checkbox" @bind="column.IsSelected" @bind:after="() => UpdateSqlPreview()" />
                                <span class="column-name" title="Right-click for options">
                                    @if (column.IsPrimaryKey)
                                    {
                                        <i class="bi bi-key text-warning"></i>
                                    }
                                    @if (column.IsForeignKey)
                                    {
                                        <i class="bi bi-arrow-right text-info"></i>
                                    }
                                    @if (column.IsComputed)
                                    {
                                        <i class="bi bi-calculator text-success"></i>
                                    }
                                    @column.Name
                                    @if (!string.IsNullOrEmpty(column.QueryAlias) && column.QueryAlias != column.Name)
                                    {
                                        <span class="column-alias">(@column.QueryAlias)</span>
                                    }
                                </span>
                                <span class="column-type">@column.DataType</span>
                                @if (column.Filter != null)
                                {
                                    <i class="bi bi-funnel-fill text-info"></i>
                                }
                                <span class="column-connector right"
                                      data-column-id="@column.Id"
                                      data-table-id="@table.Id"
                                      title="Drag to create relationship"></span>
                            </div>
                        }
                        <button class="btn btn-sm btn-link" type="button" @onclick="() => ShowAddColumnModal(table)">
                            <i class="bi bi-plus"></i> Add Column
                        </button>
                    </div>
                </div>
            }
        </div>

        <div class="sidebar">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#sql-preview">SQL</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#relationships">Relationships</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#properties">Properties</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#validation">Validation</a>
                </li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="sql-preview">
                    <div class="sql-preview">
                        <pre><code>@_generatedSql</code></pre>
                    </div>
                </div>

                <div class="tab-pane fade" id="relationships">
                    <div class="relationships-panel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Relationships (@_queryModel.Relationships.Count)</h5>
                            <button class="btn btn-sm btn-outline-secondary" @onclick="RefreshRelationshipDiagram">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>

                        @if (_queryModel.Relationships.Any())
                        {
                            <div class="relationship-list">
                                @foreach (var relationship in _queryModel.Relationships)
                                {
                                    var sourceTable = _queryModel.Tables.FirstOrDefault(t => t.Id == relationship.SourceTableId);
                                    var targetTable = _queryModel.Tables.FirstOrDefault(t => t.Id == relationship.TargetTableId);
                                    var sourceColumn = sourceTable?.Columns.FirstOrDefault(c => c.Id == relationship.SourceColumnId);
                                    var targetColumn = targetTable?.Columns.FirstOrDefault(c => c.Id == relationship.TargetColumnId);

                                    if (sourceTable != null && targetTable != null && sourceColumn != null && targetColumn != null)
                                    {
                                        <div class="relationship-item">
                                            <div class="relationship-header">
                                                <span class="join-type-badge" style="background-color: @GetJoinTypeColor(relationship.JoinType)">
                                                    @GetJoinTypeDisplayName(relationship.JoinType)
                                                </span>
                                                <div class="relationship-actions">
                                                    <button class="btn btn-sm btn-outline-primary"
                                                            @onclick="() => EditRelationship(relationship)"
                                                            title="Edit Relationship">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger"
                                                            @onclick="() => DeleteRelationship(relationship.Id)"
                                                            title="Delete Relationship">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="relationship-details">
                                                <div class="relationship-connection">
                                                    <div class="table-column">
                                                        <strong>@sourceTable.Name</strong>
                                                        <span class="column-name">@sourceColumn.Name</span>
                                                        @if (sourceColumn.IsPrimaryKey)
                                                        {
                                                            <i class="bi bi-key text-warning" title="Primary Key"></i>
                                                        }
                                                    </div>
                                                    <div class="relationship-arrow">
                                                        <i class="bi bi-arrow-right"></i>
                                                    </div>
                                                    <div class="table-column">
                                                        <strong>@targetTable.Name</strong>
                                                        <span class="column-name">@targetColumn.Name</span>
                                                        @if (targetColumn.IsPrimaryKey)
                                                        {
                                                            <i class="bi bi-key text-warning" title="Primary Key"></i>
                                                        }
                                                    </div>
                                                </div>
                                                <div class="relationship-meta">
                                                    <small class="text-muted">
                                                        Cardinality: @relationship.Cardinality
                                                        @if (!string.IsNullOrEmpty(relationship.Name))
                                                        {
                                                            <span> | Name: @relationship.Name</span>
                                                        }
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                            </div>
                        }
                        else
                        {
                            <div class="empty-state">
                                <div class="text-center text-muted">
                                    <i class="bi bi-arrow-left-right fs-1 mb-3"></i>
                                    <p>No relationships created yet</p>
                                    <p><small>Drag from column connectors to create relationships between tables</small></p>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                @*                 <div class="tab-pane fade" id="properties">
                    @if (_selectedTable != null)
                    {
                        <div class="properties-panel">
                            <h5>Table Properties</h5>
                            <div class="mb-3">
                                <label>Name:</label>
                                <input type="text" class="form-control" @bind="_selectedTable.Name" />
                            </div>
                            <div class="mb-3">
                                <label>Alias:</label>
                                <input type="text" class="form-control" @bind="_selectedTable.Alias" />
                            </div>
                            <div class="mb-3">
                                <label>Domain:</label>
                                <select class="form-control" @bind="_selectedTable.DomainId">
                                    <option value="">None</option>
                                    @foreach (var domain in _queryModel.Domains)
                                    {
                                        <option value="@domain.Id">@domain.Name</option>
                                    }
                                </select>

                            </div>
                        </div>
                    }
                </div>
 *@

                <div class="tab-pane fade" id="properties">
                    @if (_selectedTable != null)
                    {
                        <div class="properties-panel">
                            <h5>Table Properties</h5>
                            <div class="mb-3">
                                <label class="form-label">Name:</label>
                                <input type="text" class="form-control" @bind="_selectedTable.Name"
                                       @bind:after="() => UpdateSqlPreview()" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Alias:</label>
                                <input type="text" class="form-control" @bind="_selectedTable.Alias"
                                       @bind:after="() => UpdateSqlPreview()" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Schema:</label>
                                <input type="text" class="form-control" @bind="_selectedTable.Schema"
                                       @bind:after="() => UpdateSqlPreview()" />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Domain:</label>
                                <select class="form-select" value="@(_selectedTable.DomainId ?? "")"
                                        @onchange="OnTableDomainChanged">
                                    <option value="">None</option>
                                    @foreach (var domain in _queryModel.Domains)
                                    {
                                        <option value="@domain.Id">@domain.Name</option>
                                    }
                                </select>
                                <div class="form-text">
                                    Assigning to a domain will automatically move the table and adjust domain size
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Position:</label>
                                <div class="row">
                                    <div class="col">
                                        <label class="form-label text-muted">X:</label>
                                        <input type="number" class="form-control form-control-sm"
                                               @bind="_selectedTable.Position.X" readonly />
                                    </div>
                                    <div class="col">
                                        <label class="form-label text-muted">Y:</label>
                                        <input type="number" class="form-control form-control-sm"
                                               @bind="_selectedTable.Position.Y" readonly />
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Size:</label>
                                <div class="row">
                                    <div class="col">
                                        <label class="form-label text-muted">Width:</label>
                                        <input type="number" class="form-control form-control-sm"
                                               @bind="_selectedTable.Size.Width" readonly />
                                    </div>
                                    <div class="col">
                                        <label class="form-label text-muted">Height:</label>
                                        <input type="number" class="form-control form-control-sm"
                                               @bind="_selectedTable.Size.Height" readonly />
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="empty-state">
                            <div class="text-center text-muted">
                                <i class="bi bi-table fs-1 mb-3"></i>
                                <p>Select a table to view properties</p>
                                <p><small>Click on any table to see its properties here</small></p>
                            </div>
                        </div>
                    }

                    <!-- Domain Management Section -->
                    <hr />
                    <div class="domains-section">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Domains (@_queryModel.Domains.Count)</h5>
                            <button class="btn btn-sm btn-primary" @onclick="ShowCreateDomainModal">
                                <i class="bi bi-plus"></i> Add
                            </button>
                        </div>

                        @if (_queryModel.Domains.Any())
                        {
                            <div class="domain-list">
                                @foreach (var domain in _queryModel.Domains)
                                {
                                    var tablesInDomain = _queryModel.Tables.Count(t => t.DomainId == domain.Id);
                                    <div class="domain-item">
                                        <div class="domain-header-info">
                                            <div class="domain-color-indicator" style="background-color: @domain.Color"></div>
                                            <div class="domain-details">
                                                <strong>@domain.Name</strong>
                                                <small class="text-muted d-block">@tablesInDomain table(s)</small>
                                            </div>
                                        </div>
                                        <div class="domain-actions">
                                            <button class="btn btn-sm btn-outline-primary"
                                                    @onclick="() => SelectDomain(domain)"
                                                    title="Select Domain">
                                                <i class="bi bi-cursor"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger"
                                                    @onclick="() => DeleteDomain(domain.Id)"
                                                    title="Delete Domain">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="empty-state">
                                <div class="text-center text-muted">
                                    <i class="bi bi-diagram-3 fs-3 mb-2"></i>
                                    <p><small>No domains created yet</small></p>
                                </div>
                            </div>
                        }
                    </div>
                </div>
                
                <div class="tab-pane fade" id="validation">
                    <div class="validation-panel">
                        <h5>Validation Rules</h5>
                        <button class="btn btn-sm btn-primary" type="button" @onclick="AddValidationRule">
                            <i class="bi bi-plus"></i> Add Rule
                        </button>
                        @foreach (var rule in _validationRules)
                        {
                            <div class="validation-rule">
                                <input type="text" @bind="rule.Name" placeholder="Rule name" />
                                <select @bind="rule.RuleType">
                                    <option value="SQL">SQL</option>
                                    <option value="CSharp">C#</option>
                                </select>
                                <textarea @bind="rule.Expression" placeholder="Expression"></textarea>
                                <button class="btn btn-sm btn-danger" type="button" @onclick="() => RemoveValidationRule(rule)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        }
                    </div>
                </div>
          
            </div>
        </div>
    </div>

    <!-- Add Column Modal -->
    @if (showAddColumnModal)
    {
        <div class="modal fade show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-plus-circle"></i>
                            Add Column to @selectedTableForColumn?.Name
                        </h5>
                        <button type="button" class="btn-close" @onclick="CloseAddColumnModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Column Name:</label>
                                    <input type="text" class="form-control" @bind="newColumnName"
                                           placeholder="Enter column name" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Data Type:</label>
                                    <select class="form-select" @bind="newColumnDataType">
                                        <option value="int">int</option>
                                        <option value="bigint">bigint</option>
                                        <option value="varchar">varchar</option>
                                        <option value="nvarchar">nvarchar</option>
                                        <option value="char">char</option>
                                        <option value="nchar">nchar</option>
                                        <option value="text">text</option>
                                        <option value="ntext">ntext</option>
                                        <option value="decimal">decimal</option>
                                        <option value="float">float</option>
                                        <option value="real">real</option>
                                        <option value="money">money</option>
                                        <option value="datetime">datetime</option>
                                        <option value="datetime2">datetime2</option>
                                        <option value="date">date</option>
                                        <option value="time">time</option>
                                        <option value="bit">bit</option>
                                        <option value="uniqueidentifier">uniqueidentifier</option>
                                        <option value="computed">computed</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        @if (newColumnDataType != "computed")
                        {
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Max Length:</label>
                                        <input type="number" class="form-control" @bind="newColumnMaxLength"
                                               placeholder="Optional" />
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" @bind="newColumnIsNullable" />
                                        <label class="form-check-label">Allow Null</label>
                                    </div>
                                </div>
                            </div>
                        }

                        @if (newColumnDataType == "computed")
                        {
                            <div class="mb-3">
                                <label class="form-label">SQL Expression:</label>
                                <div class="form-text mb-2">
                                    Available columns: @string.Join(", ", selectedTableForColumn?.Columns?.Where(c => !c.IsComputed).Select(c => c.Name) ?? new List<string>())
                                </div>
                                <textarea class="form-control" rows="3" @bind="newColumnExpression"
                                          placeholder="Example: [FirstName] + ' ' + [LastName]"
                                          style="font-family: 'Courier New', monospace;"></textarea>
                            </div>
                        }

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" @bind="newColumnIsPrimaryKey" />
                                    <label class="form-check-label">Primary Key</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" @bind="newColumnIsForeignKey" />
                                    <label class="form-check-label">Foreign Key</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseAddColumnModal">Cancel</button>
                        <button type="button" class="btn btn-primary" @onclick="ConfirmAddColumn"
                                disabled="@(string.IsNullOrWhiteSpace(newColumnName) || (newColumnDataType == "computed" && string.IsNullOrWhiteSpace(newColumnExpression)))">
                            Add Column
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Column Alias Modal -->
    @if (showColumnAliasModal)
    {
        <div class="modal fade show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Set Column Alias</h5>
                        <button type="button" class="btn-close" @onclick="CloseColumnAliasModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Column: <strong>@selectedColumnForAlias?.Name</strong></label>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Query Alias:</label>
                            <input type="text" class="form-control" @bind="newColumnAlias"
                                   placeholder="Enter alias (leave empty to remove)" />
                            <div class="form-text">This alias will be used in the generated SQL query</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseColumnAliasModal">Cancel</button>
                        <button type="button" class="btn btn-primary" @onclick="ConfirmColumnAlias">
                            Set Alias
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Rename Table Modal -->
    @if (showRenameModal)
    {
        <div class="modal fade show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Rename Table</h5>
                        <button type="button" class="btn-close" @onclick="CloseRenameModal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Enter a new name for the table:</p>
                        <input type="text" class="form-control" @bind="newTableName" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseRenameModal">Cancel</button>
                        <button type="button" class="btn btn-primary" @onclick="HandleRenameSubmit">Rename</button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Join Type Selection Modal -->
    @if (showJoinTypeModal)
    {
        <div class="modal fade show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="bi bi-arrow-left-right"></i>
                            @(editingRelationshipId != null ? "Edit Relationship" : "Create Relationship")
                        </h5>
                        <button type="button" class="btn-close" @onclick="CloseJoinTypeModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Source Table</h6>
                                <div class="table-info">
                                    <strong>@pendingRelationship?.SourceTableName</strong>
                                    <br />
                                    Column: @pendingRelationship?.SourceColumnName
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Target Table</h6>
                                <div class="table-info">
                                    <strong>@pendingRelationship?.TargetTableName</strong>
                                    <br />
                                    Column: @pendingRelationship?.TargetColumnName
                                </div>
                            </div>
                        </div>

                        <hr />

                        <div class="mb-3">
                            <label class="form-label">Join Type:</label>
                            <div class="join-type-selection">
                                @foreach (var joinType in Enum.GetValues<JoinType>())
                                {
                                    <div class="form-check join-type-option">
                                        <input class="form-check-input" type="radio"
                                               name="joinType"
                                               id="join_@joinType"
                                               value="@joinType"
                                               @onchange="@(e => OnJoinTypeChanged(e))"
                                               checked="@(selectedJoinType == joinType)" />
                                        <label class="form-check-label" for="join_@joinType">
                                            <strong style="color: @GetJoinTypeColor(joinType);">@GetJoinTypeDisplayName(joinType)</strong>
                                            <br />
                                            <small class="text-muted">@GetJoinTypeDescription(joinType)</small>
                                        </label>
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Cardinality:</label>
                            <select class="form-select" @bind="selectedCardinality">
                                <option value="1:1">One-to-One (1:1)</option>
                                <option value="1:N">One-to-Many (1:N)</option>
                                <option value="N:1">Many-to-One (N:1)</option>
                                <option value="N:N">Many-to-Many (N:N)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Relationship Name (Optional):</label>
                            <input type="text" class="form-control" @bind="relationshipName"
                                   placeholder="e.g., CustomerOrders, UserRoles" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseJoinTypeModal">Cancel</button>
                        <button type="button" class="btn btn-primary" @onclick="ConfirmRelationship">
                            @(editingRelationshipId != null ? "Update Relationship" : "Create Relationship")
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Query Results -->
    @if (_queryResults != null)
    {
        <div class="query-results">
            <h5>Query Results (@_queryResults.Rows.Count rows)</h5>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            @foreach (System.Data.DataColumn column in _queryResults.Columns)
                            {
                                <th>@column.ColumnName</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (System.Data.DataRow row in _queryResults.Rows)
                        {
                            <tr>
                                @foreach (var item in row.ItemArray)
                                {
                                    <td>@item?.ToString()</td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    <!-- Connection Modal -->
    @if (_showConnectionModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Database Connection</h5>
                        <button type="button" class="btn-close" @onclick="CloseConnectionDialog"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Connection String:</label>
                            <textarea class="form-control" @bind="ConnectionString" rows="3"
                                      placeholder="Server=localhost;Database=YourDB;User Id=sa;Password=YourPassword;TrustServerCertificate=True"></textarea>
                        </div>
                        @if (!string.IsNullOrEmpty(_connectionError))
                        {
                            <div class="alert alert-danger">
                                @_connectionError
                            </div>
                        }
                        @if (_isConnecting)
                        {
                            <div class="alert alert-info">
                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                Connecting to database...
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseConnectionDialog">Cancel</button>
                        <button type="button" class="btn btn-primary" @onclick="ConnectToDatabase" disabled="@_isConnecting">
                            Connect
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Excel Upload Modal -->
    @if (_showExcelModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Upload Excel File</h5>
                        <button type="button" class="btn-close" @onclick="CloseExcelDialog"></button>
                    </div>
                    <div class="modal-body">
                        <!-- ExcelUpload component would go here -->
                    </div>
                </div>
            </div>
        </div>
    }


    <!-- Create Domain Modal -->
    @if (showCreateDomainModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Create Domain</h5>
                        <button type="button" class="btn-close" @onclick="CloseCreateDomainModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Domain Name:</label>
                            <input type="text" class="form-control" @bind="newDomainName" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Color:</label>
                            <input type="color" class="form-control form-control-color" @bind="newDomainColor" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseCreateDomainModal">Cancel</button>
                        <button type="button" class="btn btn-primary" @onclick="ConfirmCreateDomain">Create Domain</button>
                    </div>
                </div>
            </div>
        </div>
    }


</div>

@code {
    private QueryModel _queryModel = new();
    private string _generatedSql = "";
    private TableModel? _selectedTable;
    private List<ValidationRule> _validationRules = new();
    private System.Data.DataTable? _queryResults;
    private ElementReference canvasElement;

    private double _zoomLevel = 1.0;

    [Parameter]
    public string? ConnectionString { get; set; }

    [Parameter]
    public EventCallback<string> OnQueryGenerated { get; set; }

    // Modal states
    private bool _showConnectionModal = false;
    private bool _showExcelModal = false;
    private bool _isConnecting = false;
    private string _connectionError = "";

    // JavaScript module
    private IJSObjectReference? _jsModule;
    private DotNetObjectReference<SqlQueryBuilder>? dotNetHelper;

    // Rename modal state
    private bool showRenameModal = false;
    private string currentTableIdForRename = "";
    private string newTableName = "";

    // Join type modal state
    private bool showJoinTypeModal = false;
    private PendingRelationship? pendingRelationship;
    private JoinType selectedJoinType = JoinType.InnerJoin;
    private string selectedCardinality = "1:N";
    private string relationshipName = "";
    private string? editingRelationshipId = null;

    // Add Column modal state
    private bool showAddColumnModal = false;
    private TableModel? selectedTableForColumn;
    private string newColumnName = "";
    private string newColumnDataType = "nvarchar";
    private int? newColumnMaxLength;
    private bool newColumnIsNullable = true;
    private bool newColumnIsPrimaryKey = false;
    private bool newColumnIsForeignKey = false;
    private string newColumnExpression = "";

    // Column Alias modal state
    private bool showColumnAliasModal = false;
    private ColumnModel? selectedColumnForAlias;
    private string newColumnAlias = "";

    // Domain Modal state
    private bool showCreateDomainModal = false;
    private string newDomainName = "";
    private string newDomainColor = "#e3f2fd";

    // Auto-arrange state
    private bool isAutoArranging = false;

    // Pending relationship model
    public class PendingRelationship
    {
        public string SourceTableId { get; set; } = "";
        public string SourceColumnId { get; set; } = "";
        public string TargetTableId { get; set; } = "";
        public string TargetColumnId { get; set; } = "";
        public string SourceTableName { get; set; } = "";
        public string SourceColumnName { get; set; } = "";
        public string TargetTableName { get; set; } = "";
        public string TargetColumnName { get; set; } = "";
    }

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("VisualSqlBuilder initialized");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                dotNetHelper = DotNetObjectReference.Create(this);

                _jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>(
                    "import", "./_content/VisualSqlBuilder.Core/visual-sql-builder.js");

                await InitializeCanvas();
                await JSRuntime.InvokeVoidAsync("console.log", "Canvas initialization completed");

            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing JavaScript: {ex.Message}");
                await JSRuntime.InvokeVoidAsync("console.error", $"Canvas initialization failed: {ex.Message}");
            }
        }
    }

    private async Task InitializeCanvas()
    {
        try
        {
            if (_jsModule != null)
            {
                await _jsModule.InvokeVoidAsync("initializeSqlCanvas", canvasElement, dotNetHelper);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing canvas: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("console.error", $"Canvas initialization failed: {ex.Message}");
        }
    }

    // JavaScript-invokable methods
    [JSInvokable]
    public void ShowRenameModal(string tableId, string currentName)
    {
        currentTableIdForRename = tableId;
        newTableName = currentName;
        showRenameModal = true;
        StateHasChanged();
    }

    [JSInvokable]
    public void ShowJoinTypeSelection(string sourceTableId, string sourceColumnId, string targetTableId, string targetColumnId)
    {
        var sourceTable = _queryModel.Tables.FirstOrDefault(t => t.Id == sourceTableId);
        var targetTable = _queryModel.Tables.FirstOrDefault(t => t.Id == targetTableId);
        var sourceColumn = sourceTable?.Columns.FirstOrDefault(c => c.Id == sourceColumnId);
        var targetColumn = targetTable?.Columns.FirstOrDefault(c => c.Id == targetColumnId);

        if (sourceTable != null && targetTable != null && sourceColumn != null && targetColumn != null)
        {
            pendingRelationship = new PendingRelationship
            {
                SourceTableId = sourceTableId,
                SourceColumnId = sourceColumnId,
                TargetTableId = targetTableId,
                TargetColumnId = targetColumnId,
                SourceTableName = sourceTable.Name,
                SourceColumnName = sourceColumn.Name,
                TargetTableName = targetTable.Name,
                TargetColumnName = targetColumn.Name
            };

            selectedJoinType = JoinType.InnerJoin;
            selectedCardinality = "1:N";
            relationshipName = $"{sourceTable.Name}_{targetTable.Name}";
            editingRelationshipId = null;
            showJoinTypeModal = true;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void ShowJoinTypeModal(string relationshipId)
    {
        var relationship = _queryModel.Relationships.FirstOrDefault(r => r.Id == relationshipId);
        if (relationship != null)
        {
            var sourceTable = _queryModel.Tables.FirstOrDefault(t => t.Id == relationship.SourceTableId);
            var targetTable = _queryModel.Tables.FirstOrDefault(t => t.Id == relationship.TargetTableId);
            var sourceColumn = sourceTable?.Columns.FirstOrDefault(c => c.Id == relationship.SourceColumnId);
            var targetColumn = targetTable?.Columns.FirstOrDefault(c => c.Id == relationship.TargetColumnId);

            if (sourceTable != null && targetTable != null && sourceColumn != null && targetColumn != null)
            {
                pendingRelationship = new PendingRelationship
                {
                    SourceTableId = relationship.SourceTableId,
                    SourceColumnId = relationship.SourceColumnId,
                    TargetTableId = relationship.TargetTableId,
                    TargetColumnId = relationship.TargetColumnId,
                    SourceTableName = sourceTable.Name,
                    SourceColumnName = sourceColumn.Name,
                    TargetTableName = targetTable.Name,
                    TargetColumnName = targetColumn.Name
                };

                selectedJoinType = relationship.JoinType;
                selectedCardinality = relationship.Cardinality;
                relationshipName = relationship.Name ?? "";
                editingRelationshipId = relationshipId;
                showJoinTypeModal = true;
                StateHasChanged();
            }
        }
    }



    [JSInvokable]
    public void ShowColumnAliasModal(string tableId, string columnId)
    {
        var table = _queryModel.Tables.FirstOrDefault(t => t.Id == tableId);
        selectedColumnForAlias = table?.Columns.FirstOrDefault(c => c.Id == columnId);

        if (selectedColumnForAlias != null)
        {
            newColumnAlias = selectedColumnForAlias.QueryAlias ?? "";
            showColumnAliasModal = true;
            StateHasChanged();
        }
    }

    [JSInvokable]
    public void ToggleColumnSelection(string tableId, string columnId)
    {
        var table = _queryModel.Tables.FirstOrDefault(t => t.Id == tableId);
        var column = table?.Columns.FirstOrDefault(c => c.Id == columnId);

        if (column != null)
        {
            column.IsSelected = !column.IsSelected;
            UpdateSqlPreview();
            StateHasChanged();
        }
    }



    [JSInvokable]
    public async Task UpdateRelationshipLines()
    {
        // This method is called when tables are moved to update relationship line positions
        await RefreshRelationshipDiagram();
        StateHasChanged();
    }

    [JSInvokable]
    public async Task AutoArrangeTables()
    {
        if (isAutoArranging) return;

        isAutoArranging = true;
        StateHasChanged();

        try
        {
            // Get all tables that have relationships
            var connectedTables = _queryModel.Tables
                .Where(t => _queryModel.Relationships.Any(r => r.SourceTableId == t.Id || r.TargetTableId == t.Id))
                .ToList();

            // Arrange connected tables in a hierarchical layout
            if (connectedTables.Any())
            {
                await ArrangeConnectedTables(connectedTables);
            }

            // Arrange orphan tables separately
            var orphanTables = _queryModel.Tables.Except(connectedTables).ToList();
            if (orphanTables.Any())
            {
                ArrangeOrphanTables(orphanTables, connectedTables.Any() ? 800 : 50);
            }

            UpdateSqlPreview();
            await RefreshRelationshipDiagram();
            StateHasChanged();
        }
        finally
        {
            isAutoArranging = false;
        }
    }

    // Helper methods and remaining functionality
    private void HandleRenameSubmit()
    {
        if (!string.IsNullOrWhiteSpace(newTableName))
        {
            var table = _queryModel.Tables.FirstOrDefault(t => t.Id == currentTableIdForRename);
            if (table != null)
            {
                table.Name = newTableName;
                UpdateSqlPreview();
            }
            CloseRenameModal();
        }
    }

    private void CloseRenameModal()
    {
        showRenameModal = false;
        StateHasChanged();
    }

    private void ConfirmRelationship()
    {
        if (pendingRelationship != null)
        {
            if (editingRelationshipId != null)
            {
                // Update existing relationship
                var existingRelationship = _queryModel.Relationships.FirstOrDefault(r => r.Id == editingRelationshipId);
                if (existingRelationship != null)
                {
                    existingRelationship.JoinType = selectedJoinType;
                    existingRelationship.Cardinality = selectedCardinality;
                    existingRelationship.Name = string.IsNullOrWhiteSpace(relationshipName) ? null : relationshipName;
                }
            }
            else
            {
                // Create new relationship
                var newRelationship = new RelationshipModel
                {
                    Id = Guid.NewGuid().ToString(),
                    SourceTableId = pendingRelationship.SourceTableId,
                    SourceColumnId = pendingRelationship.SourceColumnId,
                    TargetTableId = pendingRelationship.TargetTableId,
                    TargetColumnId = pendingRelationship.TargetColumnId,
                    JoinType = selectedJoinType,
                    Cardinality = selectedCardinality,
                    Name = string.IsNullOrWhiteSpace(relationshipName) ? null : relationshipName
                };

                _queryModel.Relationships.Add(newRelationship);
            }

            UpdateSqlPreview();
            CloseJoinTypeModal();
            StateHasChanged();
        }
    }

    private void CloseJoinTypeModal()
    {
        showJoinTypeModal = false;
        pendingRelationship = null;
        editingRelationshipId = null;
        StateHasChanged();
    }

    private void CloseColumnAliasModal()
    {
        showColumnAliasModal = false;
        selectedColumnForAlias = null;
        newColumnAlias = "";
        StateHasChanged();
    }

    private void ConfirmColumnAlias()
    {
        if (selectedColumnForAlias != null)
        {
            selectedColumnForAlias.QueryAlias = string.IsNullOrWhiteSpace(newColumnAlias) ? null : newColumnAlias;
            UpdateSqlPreview();
            CloseColumnAliasModal();
        }
    }

    private async Task ArrangeConnectedTables(List<TableModel> connectedTables)
    {
        // Simple hierarchical layout algorithm
        var positioned = new HashSet<string>();
        var currentX = 50;
        var currentY = 50;
        var maxHeightInRow = 0;
        var tablesPerRow = 3;
        var tableSpacing = 320;
        var rowSpacing = 200;

        // Build a graph of relationships
        var graph = new Dictionary<string, List<string>>();
        foreach (var table in connectedTables)
        {
            graph[table.Id] = new List<string>();
        }

        foreach (var rel in _queryModel.Relationships)
        {
            if (graph.ContainsKey(rel.SourceTableId) && graph.ContainsKey(rel.TargetTableId))
            {
                graph[rel.SourceTableId].Add(rel.TargetTableId);
                graph[rel.TargetTableId].Add(rel.SourceTableId);
            }
        }

        // Find root tables (tables with most connections or primary key tables)
        var rootTables = connectedTables
            .OrderByDescending(t => graph[t.Id].Count)
            .ThenByDescending(t => t.Columns.Any(c => c.IsPrimaryKey))
            .Take(tablesPerRow)
            .ToList();

        // Position root tables first
        foreach (var table in rootTables)
        {
            table.Position = new Position { X = currentX, Y = currentY };
            positioned.Add(table.Id);

            currentX += tableSpacing;
            maxHeightInRow = Math.Max(maxHeightInRow, (int)table.Size.Height);

            if (currentX > tableSpacing * tablesPerRow)
            {
                currentX = 50;
                currentY += maxHeightInRow + rowSpacing;
                maxHeightInRow = 0;
            }
        }

        // Position remaining tables
        var remaining = connectedTables.Where(t => !positioned.Contains(t.Id)).ToList();
        foreach (var table in remaining)
        {
            table.Position = new Position { X = currentX, Y = currentY };

            currentX += tableSpacing;
            maxHeightInRow = Math.Max(maxHeightInRow, (int)table.Size.Height);

            if (currentX > tableSpacing * tablesPerRow)
            {
                currentX = 50;
                currentY += maxHeightInRow + rowSpacing;
                maxHeightInRow = 0;
            }
        }

        await Task.Delay(100); // Small delay for visual effect
    }

    private void ArrangeOrphanTables(List<TableModel> orphanTables, int startX)
    {
        var currentX = startX;
        var currentY = 50;
        var maxHeightInRow = 0;
        var tableSpacing = 320;
        var rowSpacing = 200;
        var tablesPerRow = 3;

        foreach (var table in orphanTables)
        {
            table.Position = new Position { X = currentX, Y = currentY };

            currentX += tableSpacing;
            maxHeightInRow = Math.Max(maxHeightInRow, (int)table.Size.Height);

            if (currentX > startX + (tableSpacing * tablesPerRow))
            {
                currentX = startX;
                currentY += maxHeightInRow + rowSpacing;
                maxHeightInRow = 0;
            }
        }
    }

    private void OnJoinTypeChanged(ChangeEventArgs e)
    {
        if (e.Value != null && Enum.TryParse<JoinType>(e.Value.ToString(), out var joinType))
        {
            selectedJoinType = joinType;
            StateHasChanged();
        }
    }

    // Helper methods for join type display
    private string GetJoinTypeColor(JoinType joinType)
    {
        return joinType switch
        {
            JoinType.InnerJoin => "#dc3545",
            JoinType.LeftJoin => "#0d6efd",
            JoinType.RightJoin => "#fd7e14",
            JoinType.FullOuterJoin => "#6f42c1",
            JoinType.CrossJoin => "#20c997",
            _ => "#6c757d"
        };
    }

    private string GetJoinTypeDashArray(JoinType joinType)
    {
        return joinType switch
        {
            JoinType.InnerJoin => "none",
            JoinType.LeftJoin => "5,5",
            JoinType.RightJoin => "10,5",
            JoinType.FullOuterJoin => "15,5,5,5",
            JoinType.CrossJoin => "2,2",
            _ => "none"
        };
    }

    private string GetJoinTypeDisplayName(JoinType joinType)
    {
        return joinType switch
        {
            JoinType.InnerJoin => "INNER",
            JoinType.LeftJoin => "LEFT",
            JoinType.RightJoin => "RIGHT",
            JoinType.FullOuterJoin => "FULL",
            JoinType.CrossJoin => "CROSS",
            _ => joinType.ToString().ToUpper()
        };
    }

    private string GetJoinTypeDescription(JoinType joinType)
    {
        return joinType switch
        {
            JoinType.InnerJoin => "Returns only matching records from both tables",
            JoinType.LeftJoin => "Returns all records from left table and matching from right",
            JoinType.RightJoin => "Returns all records from right table and matching from left",
            JoinType.FullOuterJoin => "Returns all records from both tables",
            JoinType.CrossJoin => "Returns cartesian product of both tables",
            _ => ""
        };
    }

    // Connection and database methods
    private void ShowConnectionDialog()
    {
        _showConnectionModal = true;
        _connectionError = "";
        StateHasChanged();
    }

    private void CloseConnectionDialog()
    {
        _showConnectionModal = false;
        _connectionError = "";
        _isConnecting = false;
        StateHasChanged();
    }

    private void CloseExcelDialog()
    {
        _showExcelModal = false;
        StateHasChanged();
    }

    public async Task ShowExcelUpload()
    {
        await JSRuntime.InvokeVoidAsync("triggerClick", "excelFileInput");
        StateHasChanged();
    }

    private async Task HandleExcelSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            using var stream = file.OpenReadStream(maxAllowedSize: 10_000_000);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);

            byte[] fileBytes = ms.ToArray();
            Console.WriteLine($"Uploaded {file.Name} with {fileBytes.Length} bytes");
        }
    }

    private async Task ConnectToDatabase()
    {
        if (string.IsNullOrWhiteSpace(ConnectionString))
        {
            _connectionError = "Please enter a connection string.";
            return;
        }

        _isConnecting = true;
        _connectionError = "";
        StateHasChanged();

        try
        {
            var tables = await SchemaService.LoadTablesFromSqlServerAsync(ConnectionString);
            var relationships = await SchemaService.LoadRelationshipsFromSqlServerAsync(ConnectionString, tables);

            _queryModel.Tables.Clear();
            _queryModel.Relationships.Clear();

            _queryModel.Tables.AddRange(tables);
            _queryModel.Relationships.AddRange(relationships);

            PositionTables();
            CloseConnectionDialog();
            UpdateSqlPreview();
            await RefreshRelationshipDiagram();
        }
        catch (Exception ex)
        {
            _connectionError = $"Connection failed: {ex.Message}";
        }
        finally
        {
            _isConnecting = false;
            StateHasChanged();
        }
    }

    private Task HandleExcelTablesImported(List<TableModel> tables)
    {
        _queryModel.Tables.AddRange(tables);
        PositionTables();
        CloseExcelDialog();
        UpdateSqlPreview();
        return Task.CompletedTask;
    }

    private Task HandleRelationshipsSuggested(List<RelationshipModel> relationships)
    {
        _queryModel.Relationships.AddRange(relationships);
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void PositionTables()
    {
        int x = 50, y = 50;
        int maxHeight = 0;

        foreach (var table in _queryModel.Tables)
        {
            table.Position = new Position { X = x, Y = y };

            x += 320; // Increased spacing to prevent overlap
            maxHeight = Math.Max(maxHeight, (int)table.Size.Height);

            if (x > 1200)
            {
                x = 50;
                y += maxHeight + 80; // Increased vertical spacing
                maxHeight = 0;
            }
        }
    }

    private void AddNewTable()
    {
        var newTable = new TableModel
        {
            Name = "NewTable",
            Alias = "nt",
            Schema = "dbo",
            Position = new Position { X = 100, Y = 100 }
        };

        newTable.Columns.Add(new ColumnModel { Name = "Id", DataType = "int", IsPrimaryKey = true });
        newTable.Columns.Add(new ColumnModel { Name = "CreatedBy", DataType = "nvarchar" });
        newTable.Columns.Add(new ColumnModel { Name = "CreatedAt", DataType = "datetime2" });
        newTable.Columns.Add(new ColumnModel { Name = "ModifiedBy", DataType = "nvarchar" });
        newTable.Columns.Add(new ColumnModel { Name = "ModifiedAt", DataType = "datetime2" });

        _queryModel.Tables.Add(newTable);
        UpdateSqlPreview();
    }

    private void SelectTable(TableModel table)
    {
        _selectedTable = table;
        StateHasChanged();
    }

    private void RemoveTable(TableModel table)
    {
        _queryModel.Tables.Remove(table);
        _queryModel.Relationships.RemoveAll(r =>
            r.SourceTableId == table.Id || r.TargetTableId == table.Id);
        UpdateSqlPreview();
        StateHasChanged();
    }

    private void EditRelationship(RelationshipModel relationship)
    {
        ShowJoinTypeModal(relationship.Id);
    }

    private void ToggleDomain(DomainModel domain)
    {
        domain.IsCollapsed = !domain.IsCollapsed;
    }

    private void AddValidationRule()
    {
        _validationRules.Add(new ValidationRule
        {
            Name = "New Rule",
            RuleType = "SQL",
            IsActive = true
        });
    }

    private void RemoveValidationRule(ValidationRule rule)
    {
        _validationRules.Remove(rule);
    }

    private void UpdateSqlPreview(QueryModel? customQueryModel = null)
    {
        try
        {
            var modelToUse = customQueryModel ?? _queryModel;
            _generatedSql = SqlGenerator.GenerateQuery(modelToUse);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _generatedSql = $"-- Error generating SQL: {ex.Message}";
        }
    }

    private void GenerateQuery()
    {
        // Only include tables that have relationships or selected columns
        var relevantTables = _queryModel.Tables.Where(t =>
            t.Columns.Any(c => c.IsSelected) ||
            _queryModel.Relationships.Any(r => r.SourceTableId == t.Id || r.TargetTableId == t.Id)
        ).ToList();

        if (!relevantTables.Any())
        {
            _generatedSql = "-- No tables selected or connected. Please select columns or create relationships.";
            StateHasChanged();
            return;
        }

        // Exclude orphan tables (tables with no relationships) unless they have selected columns
        var tablesWithRelationships = _queryModel.Tables.Where(t =>
            _queryModel.Relationships.Any(r => r.SourceTableId == t.Id || r.TargetTableId == t.Id)
        ).ToList();

        var orphanTablesWithSelectedColumns = _queryModel.Tables.Where(t =>
            !_queryModel.Relationships.Any(r => r.SourceTableId == t.Id || r.TargetTableId == t.Id) &&
            t.Columns.Any(c => c.IsSelected)
        ).ToList();

        var finalTables = tablesWithRelationships.Concat(orphanTablesWithSelectedColumns).ToList();

        if (!finalTables.Any())
        {
            _generatedSql = "-- No connected tables found. Create relationships between tables or select columns.";
            StateHasChanged();
            return;
        }

        // Create a temporary query model with only relevant tables
        var queryModelForGeneration = new QueryModel
        {
            Tables = finalTables,
            Relationships = _queryModel.Relationships.Where(r =>
                finalTables.Any(t => t.Id == r.SourceTableId) &&
                finalTables.Any(t => t.Id == r.TargetTableId)
            ).ToList()
        };

        UpdateSqlPreview(queryModelForGeneration);
    }

    [JSInvokable]
    public async Task UpdateTablePosition(string tableId, double x, double y)
    {
        var table = _queryModel.Tables.FirstOrDefault(t => t.Id == tableId);
        if (table != null)
        {
            table.Position.X = (int)x;
            table.Position.Y = (int)y;
            UpdateSqlPreview();

            // Update relationship lines after table position change
            await RefreshRelationshipDiagram();
        }
    }


    private async Task GenerateAndExecuteQuery()
    {
        GenerateQuery();

        if (!string.IsNullOrEmpty(ConnectionString) && !string.IsNullOrEmpty(_generatedSql))
        {
            try
            {
                _queryResults = await SchemaService.ExecuteQueryAsync(ConnectionString, _generatedSql, 100);

                if (OnQueryGenerated.HasDelegate)
                    await OnQueryGenerated.InvokeAsync(_generatedSql);

                StateHasChanged();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Query execution error: {ex.Message}");
            }
        }
    }

    private async Task SaveLayout()
    {
        try
        {
            var json = System.Text.Json.JsonSerializer.Serialize(_queryModel);

            if (_jsModule != null)
            {
                await _jsModule.InvokeVoidAsync("saveToLocalStorage", "sqlBuilderLayout", json);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving layout: {ex.Message}");
        }
    }

    private async Task LoadLayout()
    {
        try
        {
            if (_jsModule != null)
            {
                var json = await _jsModule.InvokeAsync<string>("loadFromLocalStorage", "sqlBuilderLayout");
                if (!string.IsNullOrEmpty(json))
                {
                    _queryModel = System.Text.Json.JsonSerializer.Deserialize<QueryModel>(json) ?? new QueryModel();
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading layout: {ex.Message}");
        }
    }

    private async Task ZoomIn()
    {
        _zoomLevel = Math.Min(_zoomLevel * 1.2, 3.0);
        if (_jsModule != null)
        {
            await _jsModule.InvokeVoidAsync("setCanvasZoom", _zoomLevel);
        }
    }

    private async Task ZoomOut()
    {
        _zoomLevel = Math.Max(_zoomLevel / 1.2, 0.3);
        if (_jsModule != null)
        {
            await _jsModule.InvokeVoidAsync("setCanvasZoom", _zoomLevel);
        }
    }

    private async Task ResetZoom()
    {
        _zoomLevel = 1.0;
        if (_jsModule != null)
        {
            await _jsModule.InvokeVoidAsync("setCanvasZoom", _zoomLevel);
        }
    }

    // Modal event handlers
    private void ShowAddColumnModal(TableModel table)
    {
        selectedTableForColumn = table;
        newColumnName = "";
        newColumnDataType = "nvarchar";
        newColumnMaxLength = null;
        newColumnIsNullable = true;
        newColumnIsPrimaryKey = false;
        newColumnIsForeignKey = false;
        newColumnExpression = "";
        showAddColumnModal = true;
        StateHasChanged();
    }

    private void CloseAddColumnModal()
    {
        showAddColumnModal = false;
        selectedTableForColumn = null;
        StateHasChanged();
    }

    private void ConfirmAddColumn()
    {
        if (selectedTableForColumn != null && !string.IsNullOrWhiteSpace(newColumnName))
        {
            var newColumn = new ColumnModel
            {
                Id = Guid.NewGuid().ToString(),
                Name = newColumnName,
                DataType = newColumnDataType,
                MaxLength = newColumnMaxLength,
                IsNullable = newColumnIsNullable,
                IsPrimaryKey = newColumnIsPrimaryKey,
                IsForeignKey = newColumnIsForeignKey,
                IsComputed = newColumnDataType == "computed",
                ComputedExpression = newColumnDataType == "computed" ? newColumnExpression : null
            };

            selectedTableForColumn.Columns.Add(newColumn);
            UpdateSqlPreview();
            CloseAddColumnModal();
        }
    }

    //Calculate connector position for precise dot-to-dot connections
    private Position GetConnectorPosition(TableModel table, ColumnModel column, string side)
    {
        var columnIndex = table.Columns.IndexOf(column);
        var headerHeight = 40;
        var rowHeight = 30;
        var connectorOffset = side == "right" ? table.Size.Width : 0;

        return new Position
        {
            X = table.Position.X + connectorOffset,
            Y = table.Position.Y + headerHeight + (columnIndex * rowHeight) + (rowHeight / 2)
        };
    }

    //Refresh relationship diagram
    private async Task RefreshRelationshipDiagram()
    {
        if (_jsModule != null)
        {
            await _jsModule.InvokeVoidAsync("refreshAllRelationshipLines");
        }
        StateHasChanged();
    }

    [JSInvokable]
    public void DeleteRelationship(string relationshipId)
    {
        var relationship = _queryModel.Relationships.FirstOrDefault(r => r.Id == relationshipId);
        if (relationship != null)
        {
            _queryModel.Relationships.Remove(relationship);
            UpdateSqlPreview();
            StateHasChanged();
        }
    }

    private void ShowCreateDomainModal()
    {
        newDomainName = "";
        newDomainColor = "#e3f2fd";
        showCreateDomainModal = true;
        StateHasChanged();
    }

    private void CloseCreateDomainModal()
    {
        showCreateDomainModal = false;
        StateHasChanged();
    }

    private void ConfirmCreateDomain()
    {
        if (!string.IsNullOrWhiteSpace(newDomainName))
        {
            CreateDomain(newDomainName, new Position { X = 100, Y = 100 },
                        new Size { Width = 400, Height = 300 }, newDomainColor);
            CloseCreateDomainModal();
        }
    }

    private void CreateDomain(string name, Position position, Size size, string color)
    {
        var domain = new DomainModel
        {
            Id = Guid.NewGuid().ToString(),
            Name = name,
            Position = position,
            Size = size,
            Color = color,
            IsCollapsed = false
        };

        _queryModel.Domains.Add(domain);
        StateHasChanged();
    }

    // Add these methods to your SqlQueryBuilder.razor component

    [JSInvokable]
    public async Task AssignTableToDomain(string tableId, string domainId)
    {
        var table = _queryModel.Tables.FirstOrDefault(t => t.Id == tableId);
        if (table != null)
        {
            var oldDomainId = table.DomainId;
            table.DomainId = domainId;

            if (!string.IsNullOrEmpty(domainId))
            {
                await MoveTableToDomain(table, domainId);
            }

            // Adjust old domain if table was previously assigned
            if (!string.IsNullOrEmpty(oldDomainId))
            {
                await AdjustDomainSize(oldDomainId);
            }

            // Adjust new domain
            if (!string.IsNullOrEmpty(domainId))
            {
                await AdjustDomainSize(domainId);
            }

            StateHasChanged();
            await RefreshRelationshipDiagram();
        }
    }

    private async Task MoveTableToDomain(TableModel table, string domainId)
    {
        var domain = _queryModel.Domains.FirstOrDefault(d => d.Id == domainId);
        if (domain == null) return;

        // Find optimal position within domain
        var newPosition = FindOptimalPositionInDomain(table, domain);

        table.Position.X = newPosition.X;
        table.Position.Y = newPosition.Y;

        // Update the DOM element position
        if (_jsModule != null)
        {
            await _jsModule.InvokeVoidAsync("updateTablePosition", table.Id, newPosition.X, newPosition.Y);
        }
    }

    private Position FindOptimalPositionInDomain(TableModel table, DomainModel domain)
    {
        const int padding = 20;
        const int headerHeight = 40;
        const int tableSpacing = 20;

        // Get tables already in this domain
        var tablesInDomain = _queryModel.Tables
            .Where(t => t.DomainId == domain.Id && t.Id != table.Id)
            .ToList();

        // Start position (top-left of domain with padding)
        var startX = domain.Position.X + padding;
        var startY = domain.Position.Y + headerHeight + padding;

        if (!tablesInDomain.Any())
        {
            return new Position { X = startX, Y = startY };
        }

        // Try to place table in a grid pattern within domain
        var currentX = startX;
        var currentY = startY;
        var maxHeightInRow = 0;
        var tablesPerRow = Math.Max(1, (domain.Size.Width - (padding * 2)) / (table.Size.Width + tableSpacing));

        // Find next available position
        var occupiedPositions = tablesInDomain.Select(t => new Rectangle
        {
            X = t.Position.X,
            Y = t.Position.Y,
            Width = t.Size.Width,
            Height = t.Size.Height
        }).ToList();

        while (IsPositionOccupied(currentX, currentY, table.Size.Width, table.Size.Height, occupiedPositions))
        {
            currentX += table.Size.Width + tableSpacing;

            if (currentX + table.Size.Width > domain.Position.X + domain.Size.Width - padding)
            {
                currentX = startX;
                currentY += maxHeightInRow + tableSpacing;
                maxHeightInRow = 0;
            }

            maxHeightInRow = Math.Max(maxHeightInRow, table.Size.Height);
        }

        return new Position { X = currentX, Y = currentY };
    }

    private bool IsPositionOccupied(int x, int y, int width, int height, List<Rectangle> occupiedPositions)
    {
        var testRect = new Rectangle { X = x, Y = y, Width = width, Height = height };

        return occupiedPositions.Any(occupied =>
            testRect.X < occupied.X + occupied.Width + 10 &&
            testRect.X + testRect.Width + 10 > occupied.X &&
            testRect.Y < occupied.Y + occupied.Height + 10 &&
            testRect.Y + testRect.Height + 10 > occupied.Y
        );
    }

    private async Task AdjustDomainSize(string domainId)
    {
        var domain = _queryModel.Domains.FirstOrDefault(d => d.Id == domainId);
        if (domain == null) return;

        var tablesInDomain = _queryModel.Tables.Where(t => t.DomainId == domainId).ToList();

        if (!tablesInDomain.Any())
        {
            // If no tables, set minimum size
            domain.Size.Width = 300;
            domain.Size.Height = 200;
            return;
        }

        const int padding = 20;
        const int headerHeight = 40;

        // Calculate bounds needed to contain all tables
        var minX = tablesInDomain.Min(t => t.Position.X);
        var minY = tablesInDomain.Min(t => t.Position.Y);
        var maxX = tablesInDomain.Max(t => t.Position.X + t.Size.Width);
        var maxY = tablesInDomain.Max(t => t.Position.Y + t.Size.Height);

        // Ensure domain position encompasses all tables
        var newDomainX = Math.Min(domain.Position.X, minX - padding);
        var newDomainY = Math.Min(domain.Position.Y, minY - headerHeight - padding);

        // Calculate required size
        var requiredWidth = maxX - newDomainX + padding;
        var requiredHeight = maxY - newDomainY + padding;

        // Update domain bounds
        domain.Position.X = newDomainX;
        domain.Position.Y = newDomainY;
        domain.Size.Width = Math.Max(300, requiredWidth); // Minimum width
        domain.Size.Height = Math.Max(200, requiredHeight); // Minimum height

        StateHasChanged();
    }

    // Update the table assignment in properties panel
    private async Task OnTableDomainChanged(ChangeEventArgs e)
    {
        if (_selectedTable != null && e.Value != null)
        {
            var newDomainId = e.Value.ToString();
            await AssignTableToDomain(_selectedTable.Id, newDomainId);
        }
    }


    public async ValueTask DisposeAsync()
    {
        dotNetHelper?.Dispose();
        if (_jsModule != null)
        {
            await _jsModule.DisposeAsync();
        }
    }
}
